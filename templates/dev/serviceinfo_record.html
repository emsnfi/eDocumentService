{% extends "base_nav.html" %}
{% block title %}
服務紀錄
{% endblock %}

{% block content %}
{% csrf_token %}
{% include 'dev/table_component_div.html' %}

<div id="serviceinfo_record" class="container">
	<h3>服務紀錄</h3>

	<ul class="nav nav-tabs">
		<li class="active"><a href="#serviceinfo_record_notyetredeem" name="serviceinfo_record_tab_grp" data-toggle="tab" aria-expanded="true">未兌換</a></li>
		<li><a href="#serviceinfo_record_redeeming" name="serviceinfo_record_tab_grp" data-toggle="tab" aria-expanded="false">兌換中</a></li>
		<li><a href="#serviceinfo_record_redeemed" name="serviceinfo_record_tab_grp" data-toggle="tab" aria-expanded="false">已兌換</a></li>
	</ul>
	<div class="tab-content" style="padding:20px 0px;">
		<div id="serviceinfo_record_notyetredeem" class="tab-pane active">
			<h4>未兌換</h4>
			<h4 style="margin-top:30px;">Step1: 勾選欲兌換之服務紀錄</h4>
			<hr style="margin-top:5px;">
			<div style="margin-bottom:60px;">
				<button class="btn btn-default" @click="editrecord_select_all()">全選</button>
				<button class="btn btn-default" @click="editrecord_checks=[]">全不選</button>
				<button class="btn btn-default" type="Button" @click="editrecord_select_inv()">反向選</button>
				<table-component :data="editrecords" :columns="editrecords_columns">
					<template slot="id" slot-scope="props">
				      	<input type="checkbox" v-model="editrecord_checks" :value="props.item.id">
				    </template>
				</table-component>
			</div>
			<h4>Step2: 確認後進行兌換</h4>
			<hr style="margin-top:5px;">
			<div style="margin-bottom:60px;">
				<div class="form-inline">
					<div class="form-group" style="margin-right:15px;">
						<label for="sel_exchangecenter" style="margin:0px;">
							選擇兌換中心
							<select v-model="org_select" class="form-control">
								<option
									v-for="item in org_list"
									:value="item.id"
								>
									{|{ item.name }|}
								</option>
							</select>
						</label>
					</div>
				</div>
				<button
					@click="serviceinfo_create()"
					class="btn btn-primary" style="margin-top:10px;"
				>兌換</button>
			</div>
		</div>

		<div id="serviceinfo_record_redeeming" class="tab-pane">
			<h4>兌換中</h4>
			<table-component :data="exchange_false_serviceinfos" :columns="exchange_serviceinfos_columns">
				<template slot="editrecord_set" slot-scope="props">
			      	<button type="button" class="btn btn-default" @click="serviceinfoEditrecord(props.item.editrecord_set)">詳細服務紀錄</button>
			    </template>
			</table-component>

		</div>

		<div id="serviceinfo_record_redeemed" class="tab-pane">
			<h4>已兌換</h4>
			<table-component :data="exchange_true_serviceinfos" :columns="exchange_serviceinfos_columns">
				<template slot="editrecord_set" slot-scope="props">
			      	<button type="button" class="btn btn-default" @click="serviceinfoEditrecord(props.item.editrecord_set)">詳細服務紀錄</button>
			    </template>
			</table-component>
		</div>
	</div>
</div>
<script>
	function serviceinfos_data(v){
		temp_data = {
			date: v['date'],
			service_hours: v['service_hours'],
			org: cstr(getorg(v.org).name),
			editrecord_set: v.editrecord_set,
		};

		filter_data.push(temp_data);
	}

	Vue.options.delimiters = ['{|{', '}|}'];
	vo_serviceinfo_record = new Vue({
		el: '#serviceinfo_record',
		data: {
			editrecords: [],
			editrecords_columns: {
				id: '核取',
				get_date: '服務時間',
				service_hours: '服務時數',
				stay_hours: '線上時數',
				category: '類型',
			},
			exchange_false_serviceinfos: [],
			exchange_true_serviceinfos: [],
			exchange_serviceinfos_columns: {
				date: '兌換日期',
				service_hours: '服務時數',
				org: '兌換單位',
				editrecord_set: '服務紀錄',
			},
			org_list: [],
			erurl: '/ebookSystem/api/editrecords/',
			siurl: '/genericUser/api/serviceinfos/',
			editrecord_checks: [],
			org_select: '1',
		},
		computed: {
			transferData: function(){
				return {
					"editrecord_set": this.editrecord_checks,
					"date": moment().format('YYYY-MM-DD'),
					"service_hours": this.service_hours,
					"is_exchange": false,
					"user": user.id,
					"org": this.org_select,
				}
			},
			service_hours: function(){
				let self = this

				service_hour = 0
				_.each(self.editrecords, function(v){
					if(_.includes(self.editrecord_checks, v.id)){
						service_hour += v.service_hours
					}
				})
				return service_hour
			},
		},
		created: function () {
			this.client = new $.RestClient('/genericUser/api/');
			this.client.add('serviceinfos');
			this.refresh()
		},
		methods: {
			refresh: function(){
				let self = this

				self.editrecords = []
				self.editrecord_checks = []
				rest_aj_send('get', self.erurl, {'editor_id': user.id, 'exchange': 'false',})
				.done(function(data) {
					_.each(data['data'], function(v){
						temp_data = {
							id: v['id'],
							get_date: v['get_date'],
							service_hours: v['service_hours'],
							stay_hours: v['stay_hours'],
							category: v['category'],
						};
						self.editrecords.push(temp_data);
						self.editrecord_checks.push(v.id)
					})
				})

				rest_aj_send('get', self.siurl, {'user_id': user.id, 'is_exchange': 'false',})
				.done(function(data) {
					filter_data = [];
					_.each(data['data'], serviceinfos_data)
					self.exchange_false_serviceinfos = filter_data;
				})
				rest_aj_send('get', self.siurl, {'user_id': user.id, 'is_exchange': 'true',})
				.done(function(data) {
					filter_data = [];
					_.each(data['data'], serviceinfos_data)
					self.exchange_true_serviceinfos = filter_data;
				})

				rest_aj_send('get', '/genericUser/api/organizations/', {})
				.done(function(data) {
					self.org_list = data['data']
				})

			},
			editrecord_select_all: function(){
				let self = this

				_.each(self.editrecords, function(v){
					self.editrecord_checks.push(v.id)
				})
			},
			editrecord_select_inv: function(){
				let self = this

				temp = []
				_.each(self.editrecords, function(v){
					if(!_.includes(self.editrecord_checks, v.id)){
					temp.push(v.id)
					}
				})
				self.editrecord_checks = temp
			},
			serviceinfo_create: function(){
				let self = this

				//create
				self.client.serviceinfos.create(self.transferData)
				.done(function(data) {
					alertmessage('success', '申請兌換時數' +o2j(data['service_hours']) +'，請等待核發。')
					self.refresh()

				})
				.fail(function(data){
					alertmessage('error', data['message'])
				})

			},
			serviceinfoEditrecord: function(editrecord_set){
				ServiceinfoEditrecord(editrecord_set);
			}
		}
	})
</script>
{% endblock %}