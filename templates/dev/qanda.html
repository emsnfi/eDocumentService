{% extends "base_nav.html" %}
{% block title %}
平台Q&A
{% endblock %}
{% block content %}
{% include 'comp/qanda_vue_component.html' %}
{% csrf_token %} 

<script>
	let vo_qanda;

	$(function(){

		//refresh
		qanda_refresh();

	})

	function aj_qanda(mode, aid, transferData) {
		//Q&A API顯示、新增、更新、刪除

		//df
		let df = GenDF();

		if (mode === 'create') {
			let err = [];
			if (iser(transferData.question)) {
				err.push('問題不能為空');
			}
			if (iser(transferData.answer)) {
				err.push('回答不能為空');
			}
			if (err.length > 0) {

				//msg
				let msg = _.chain(err)
					.map(function (v, k) {
						return '<div style="margin-top:5px;">' + cstr(k + 1) + ': ' + v + '</div>';
					})
					.join('')
					.value();
				msg = '<div>輸入錯誤訊息如下：</div>' + msg;

				//reject
				df.reject({ 'status': 'error', 'message': msg });

				return df;
			}
		}

		//client
		let client = new $.RestClient('/genericUser/api/');
		client.add('qandas');

		if (mode === 'list') {
			result_client = client.qandas.read();
		}
		else if (mode === 'create') {
			result_client = client.qandas.create(transferData);
		}
		else if (mode === 'update') {
			transferData['id'] = aid;
			result_client = client.qandas.update(aid, transferData);
		}
		else if (mode === 'delete') {
			result_client = client.qandas.destroy(aid);
		}
		else {

			//reject
			df.reject({ 'status': 'error', 'message': ' mode error' });

			return df;
		}

		result_client
			.done(function (data) {
				df.resolve({
					'status': 'success',
					'message': '成功',
					'content': data,
				});
			})

		return df;
	}

</script>

<script>

	//qanda_refresh
	function qanda_refresh(){

		//aj_qanda
		aj_qanda('list')
		.done(function(d){
			//opt
			let opt={
				el: '#' + 'id_qanda_list',
				data: {
					s:{
						qa:d.content,
						{% if request.user.is_manager %}
						mode:'foredit', //forshow foredit
						{% else %}
						mode:'forshow', //forshow foredit
						{% endif %}
					}
				},
			};

			//vo
			if(iser(vo_qanda)){
				vo_qanda = new Vue(opt);
			}
			else{
				vo_qanda.s.qa=d.content;
			}

		})

	}

</script>

<h3>平台Q&A</h3>

<div style="padding-bottom:30px;">
	<vu-qanda id="id_qanda_list" v-bind:s="s"></vu-qanda>
</div>

{% endblock %}