{% extends "base_nav.html" %}
{% block title %}
平台書庫
{% endblock %}

{% block content %}
{% csrf_token %}
{% include 'dev/table_component_div.html' %}
{% include 'comp/tab.vue' %}

<h3>平台書庫</h3>

<ul class="nav nav-tabs">
	<li class="active"><a href="#book_repository_recommend" name="repository_books_tab_grp" data-toggle="tab" aria-expanded="true" onclick="pagetab_subtabfix(this);">書籍推薦</a></li>
	<li><a href="#book_repository_index" name="repository_books_tab_grp" data-toggle="tab" aria-expanded="false" onclick="pagetab_subtabfix(this);">索引</a></li>
	<li><a href="#book_repository_search" name="repository_books_tab_grp" data-toggle="tab" aria-expanded="false" onclick="pagetab_subtabfix(this);">查詢</a></li>
</ul>

<div class="tab-content" style="padding:20px 0px;">
	<div id="book_repository_recommend" class="tab-pane active">
		<h4 class="textfornvda">書籍推薦</h4>
		<tab :data="data">
			<template slot="table" slot-scope="props">
				<table-component :data="props.item" :columns="bookinfo_columns">
					<template slot="action" slot-scope="props">
						<button class="btn btn-default" :ISBN="props.item.ISBN" onclick="aj_borrowbook(this, 'check_out' )">借閱</button>
						<a class="btn btn-default" role="button"
							:href="'/ebookSystem/library_origin_view?ISBN=' +props.item.ISBN"
							target="_blank" title="閱讀(另開新視窗)"
						>閱讀</a>
					</template>
				</table-component>
			</template>
		</tab>
	</div>
	<div id="book_repository_index" class="tab-pane">
		<h4 class="textfornvda">索引</h4>
		<tab :data="data">
			<template slot="table" slot-scope="props">
				<table-component :data="props.item" :columns="bookinfo_columns">
					<template slot="action" slot-scope="props">
						<button class="btn btn-default" :ISBN="props.item.ISBN" onclick="aj_borrowbook(this, 'check_out' )">借閱</button>
						<a class="btn btn-default" role="button"
							:href="'/ebookSystem/library_origin_view?ISBN=' +props.item.ISBN"
							target="_blank" title="閱讀(另開新視窗)"
						>閱讀</a>
					</template>
				</table-component>
			</template>
		</tab>
		</tab>
	</div>
	<div id="book_repository_search" class="tab-pane">
		<h4 class="textfornvda">查詢</h4>
		<div class="form-inline" style="margin-bottom:20px;">
			<div class="form-group">
				<input v-model="search_value" id="search_value" class="form-control" type="text" placeholder="輸入欲查詢資訊" maxlength="15">
			</div>
			<div class="form-group">
				<button type="button" class="btn btn-primary" @click="search()">搜尋</button>
			</div>
		</div>
		<table-component :data="bookinfos" :columns="bookinfo_columns">
			<template slot="action" slot-scope="props">
				<button class="btn btn-default" :ISBN="props.item.ISBN" onclick="aj_borrowbook(this, 'check_out' )">借閱</button>
				<a class="btn btn-default" role="button"
					:href="'/ebookSystem/library_origin_view?ISBN=' +props.item.ISBN"
					target="_blank" title="閱讀(另開新視窗)"
				>閱讀</a>
			</template>
		</table-component>
	</div>
</div>

<script>

	function bookinfos_data(v){
		temp_data = {
			"ISBN": v['ISBN'],
			"bookname": v['bookname'],
			"bookbinding": v['bookbinding'],
			"order": v['order'],
			"author": v['author'],
			"house": v['house'],
			"date": v['date'],
			"action": v['ISBN'],
		}

		filter_data.push(temp_data)

	}

	bookinfo_columns = {
		"ISBN": "ISBN",
		"bookname": "書名",
		"bookbinding": "裝訂冊數",
		"order": "版次",
		"author": "作者",
		"house": "出版社",
		"date": "出版日期",
		"action": "動作",
	}

	Vue.options.delimiters = ['{|{', '}|}'];

	new Vue({
		el: '#book_repository_recommend',
		data: {
			bookinfo_columns: bookinfo_columns,
			data: [
				{
					'order': 0,
					'display_name': '最新上架',
					'value': 'newest',
					'type': 'table',
					'data': '',
				},
				{
					'order': 1,
					'display_name': '平台推薦',
					'value': 'recommend',
					'type': 'table',
					'data': '',
				},
				{
					'order': 2,
					'display_name': '借閱排行',
					'value': 'hottest',
					'type': 'table',
					'data': '',
				},
			],
		},
		created: function () {
			this.get_table_data();
		},
		methods: {
			get_table_data: function () {
				// run ajax get data
				let self = this;

				_.each(self.data, function(v){
					query = {}
					query[v.value] = 8
					rest_aj_send('get', '/ebookSystem/api/bookinfos/', query)
					.done(function(data) {

						filter_data = []
						_.each(data['data'], bookinfos_data)
						v.data = filter_data

					})
				})
			},
		},
	})

	new Vue({
		el: '#book_repository_index',
		data: {
			bookinfo_columns: bookinfo_columns,
			data: [
				{
					'order': 0,
					'display_name': '總類',
					'value': '0',
					'type': 'table',
					'data': '',
				},
				{
					'order': 1,
					'display_name': '哲學',
					'value': '1',
					'type': 'table',
					'data': '',
				},
				{
					'order': 2,
					'display_name': '宗教',
					'value': '2',
					'type': 'table',
					'data': '',
				},
				{
					'order': 3,
					'display_name': '科學',
					'value': '3',
					'type': 'table',
					'data': '',
				},
				{
					'order': 4,
					'display_name': '應用科學',
					'value': '4',
					'type': 'table',
					'data': '',
				},
				{
					'order': 5,
					'display_name': '社會科學',
					'value': '5',
					'type': 'table',
					'data': '',
				},
				{
					'order': 6,
					'display_name': '史地類',
					'value': '6',
					'type': 'table',
					'data': '',
				},
				{
					'order': 7,
					'display_name': '世界史地',
					'value': '7',
					'type': 'table',
					'data': '',
				},
				{
					'order': 8,
					'display_name': '語言文學',
					'value': '8',
					'type': 'table',
					'data': '',
				},
				{
					'order': 9,
					'display_name': '乙術',
					'value': '9',
					'type': 'table',
					'data': '',
				},
			],
		},
		created: function () {
			this.get_table_data();
		},
		methods: {
			get_table_data: function () {
				// run ajax get data
				let self = this;

				i=0
				_.each(self.data, function(v){
					let index = i;
					i=i+1
					rest_aj_send('get', '/ebookSystem/api/bookinfos/', {'chinese_book_category': v.value})
					.done(function(data) {

						filter_data = []
						_.each(data['data'], bookinfos_data)
						v.data = filter_data

					})
				})
			},
		}
	})

	new Vue({
		el: '#book_repository_search',
		data: {
			search_value: '',
			bookinfos: [],
			bookinfo_columns: bookinfo_columns,
		},
		methods: {
			search: function () {

				let self = this
				self.bookinfos = []

				rest_aj_send('get', '/ebookSystem/api/bookinfos/', {'search': self.search_value})
				.done(function(data) {
					filter_data = []
					_.each(data['data'], bookinfos_data)
					self.bookinfos = filter_data
					alertmessage('success', '查詢完成，共取得 ' +self.bookinfos.length +' 筆資料')
				})

			},
		},
	})

</script>
{% endblock %}