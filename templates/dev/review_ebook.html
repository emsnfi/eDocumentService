{% extends "ebookSystem/review.html" %}
{% load staticfiles %}
{% block title %}
{{ part }}審核
{% endblock %}

{% block content %}
{% csrf_token %}
<h3>審核</h3>

<div id="review_ebook">
	<h4>
	<span class="glyphicon glyphicon-check" aria-hidden="true" style="margin-top:20px;"></span> Step1: 基本資料</h4>
	<hr style="margin-top:5px;">
	<ul>
		<li>服務時間：{|{ info.get_date }|}</li>
		<li>服務時數：{|{ info.service_hours }|}</li>
		<li>線上時數：{|{ info.stay_hours }|}</li>
	</ul>

	<!-- step 2 -->
	<h4>
	<span class="glyphicon glyphicon-check" aria-hidden="true" style="margin-top:20px;"></span> Step2: 校對差異分析</h4>
	<hr style="margin-top:5px;">
	<table class="table table-striped table-hover">
		<tr>
			<th>編輯距離</th>
			<th>相同區數</th>
			<th>相同字數</th>
			<th>刪除字數</th>
			<th>新增字數</th>
			<th>原始字數</th>
			<th>校後字數</th>
			<th>增長字數</th>
		</tr>
		<tr>
			<td>{|{ analysis.edit_distance }|}</td>
			<td>{|{ analysis.len_block }|}</td>
			<td>{|{ analysis.same_character }|}</td>
			<td>{|{ analysis.delete_count }|}</td>
			<td>{|{ analysis.insert_count }|}</td>
			<td>{|{ analysis.src_count }|}</td>
			<td>{|{ analysis.dst_count }|}</td>
			<td>{|{ analysis.diff_count }|}</td>
		</tr>
	</table>

	<!--step 3-->
	<h4>
	<span class="glyphicon glyphicon-check" aria-hidden="true" style="margin-top:20px;"></span> Step3: 審核結果</h4>
	<hr style="margin-top:5px;">
	<div class="form-group">
		<input type="radio" id="success" value="success" v-model="result">
		<label for="success">成功</label>
		<br>
		<input type="radio" id="error" value="error" v-model="result">
		<label for="error">退回</label>
		<br>
		<template v-if="result=='error'">
			<label for="reason">原因</label>
			<input type="text" id="reason" v-model="reason">
		</template>
	</div>
	<button  class="btn btn-primary" @click="review()" type="submit" id="send_id" name="send">送出</button>
</div>

<script>
	Vue.options.delimiters = ['{|{', '}|}'];

	new Vue({
		el: '#review_ebook',
		data: {
			info: {},
			analysis: {},
			reason: '',
			result: 'success', //success or error
		},
		computed: {
			url_ebook: function () {
				return '/ebookSystem/api/ebooks/' +this.info.part +'/'
			},
			url_editrecord: function () {
				return '/ebookSystem/api/editrecords/' +this.pk +'/'
			},
		},
		created: function () {
			let self = this;

			this.pk = window.location.pathname.split('/')
			this.pk = this.pk[this.pk.length-2]

			rest_aj_send('get', this.url_editrecord +'action/analysis/', {})
			.done(function(data) {
				self.analysis = data['data']
			})

			rest_aj_send('get', this.url_editrecord, {})
			.done(function(data) {
				self.info = data['data']
			})

		},
		methods: {
			review: function () {

				transferData = {
					'number_of_times':  this.info.number_of_times,
					'result': this.result,
					'reason': this.reason,
				}

				rest_aj_send('post', this.url_ebook +'action/review/', transferData)
				.done(function(data) {
					alertmessage('success', '審核已完成' +data['message'])
				})
				.fail(function(data){
					alertmessage('error', '' +data['message'])
				})

			},
		}

	})
</script>
{% endblock %}