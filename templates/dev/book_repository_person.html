{% extends "base_nav.html" %}
{% load staticfiles %}
{% block title %}
校對進度
{% endblock %}
{% block style %}
 <script language="javascript" src="{% static 'ebookSystem/js/ajaxSubmit.js' %}"></script>
{% endblock %}
{% block header %}
校對進度
{% endblock %}
{% block content %}
{% include 'utils/dialog.html' %}


<script>
	let user;
	$(function(){

		let user_id = $('div[user_id]').attr('user_id');
		if(user_id!='None'){
			//client
			let client = new $.RestClient('/genericUser/api/', {
				ajax: {
					async: false,
				},
			});

			client.add('users');

			//read
			client.users.read(user_id)
				.done(function (data, textStatus, xhrObject) {
					user = Object.assign(data);
					console.log(textStatus)
				})
			//console.log(user);
		} else {
			user = {};
		}

		$('#repository_books_div_havedoc').append('<div id="book_list_owner_id_' +user.id +'"></div>')
		book_list_restAPI('book_list', user.id, 'owner_id');
	})

	function book_list_restAPI(block_id, value, key) {
		//client
		let client = new $.RestClient('/ebookSystem/api/');
		client.add('bookinfos');

		//read
		client.bookinfos.read({[key]: value})
			.done(function (data) {
				let sr = [];
				_.each(data, function (v, k) {
					let o = {
						'ISBN': v.ISBN,
						'書名': v.bookname,
						'裝訂冊數': v.bookbinding,
						'版次': v.order,
						'作者': v.author,
						'出版社': v.house,
						'出版日期': v.date,
					};

					//console.log(user.is_guest);
					if(user.is_guest){
						o['動作'] =
							'<button type="button" class="btn btn-default" ISBN="' +v.ISBN +'" onclick="aj_borrowbook(this, "check_out")">借閱</button>'
							+'<a class="btn btn-default" role="button" href="/ebookSystem/library_origin_view?ISBN=' +v.ISBN +'" target="_blank" title="閱讀(另開新視窗)">閱讀</a>';
					}

					sr.push(o);
					//console.log(o);
				})

				//check
				if (iser(sr)) {
					// $('#div_serviceinfo_list_panel').html('目前無服務紀錄');
					// $('#sel_exchangecenter').prop('disabled', true);
					// $('#btn_serviceinfo_exchange').attr('onclick', '').prop('disabled', true);
					return;
				}

				//gentable
				let book_list = block_id +'_' +key +'_' +value;
				let book_list_table = book_list + '_table' ;
				gentable(book_list, book_list_table, sr);

				//table
				$('#' + book_list_table).find('tr').each(function () {
					let tr = $(this);
					tr.css('text-align', 'center');
				})

			});

	}

</script>

<form action="" method="post">
{% csrf_token %}

	<h4 class="page-header">校對文件進度</h4>
	<table class="table table-striped table-hover">
		<tr>
			<th>文件</th>
			<th>頁數/總頁數</th>
			<th>時數</th>
			<th>資訊</th>
			<th>權重</th>
			<th colspan="2">動作</th>
		</tr>
		{% for book in edit_book_list %}
		<tr>
			<td>{{book.book_info.bookname}}</td>
			<td>{{book.collect_finish_page_count}}/{{book.page_count}}</td>
			<td>{{book.collect_service_hours}}</td>
			<td><a href ="{% url 'ebookSystem:detail' book.ISBN %}" >詳細資訊</a></td>
			<td>{{ book.priority }}</td>
			<td>
				{% if book.status_int2str == 'inactive' %}
				<button class="btn btn-default send_button" type="button" name="delete" onclick="BookDeleterePository('{{book.ISBN}}')">刪除</button>
				{% else %}
				<button class="btn btn-default send_button" type="button" name="set_priority" onclick="BookSetPriority('{{book.ISBN}}')">設定權重</button>
				{% endif %}
			</td>
		</tr>
		{% endfor %}
	</table>

	<h4 class="page-header">您擁有的文件</h4>
	<div id="repository_books_div_havedoc"></div>

</form>
{% endblock %}