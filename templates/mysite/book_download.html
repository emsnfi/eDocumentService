{% extends "base_nav.html" %}
{% block title %}
書籍下載
{% endblock %}
{% block content %}

{% csrf_token %}
{% include 'comp/table-div-order.vue' %}

<div id="book_download">
	<h2>書籍下載</h2>
	<table-div
		:header="statistics_header"
		:datas="statistics_datas"
	></table-div>
</div>

<script>

function fill_cell(array, fields, value){
	_.each(array, function(v){
		_.each(fields, function(field){
		if(!v.hasOwnProperty(field))
			v[field] = value
		})
	})
}

function genMonth(v){
	let today = new Date()
	let year, month, date

	year = today.getFullYear()
	month = today.getMonth()+1
	date = today.getDate()

	let year_begin, month_begin, year_end, month_end

	if(month-v<=0){
		year_begin = year -1
		month_begin = month-v+12
	}
	else {
		year_begin = year
		month_begin = month-v
	}

	if(month-v+1<=0){
		year_end = year -1
		month_end = month-v+1+12
	}
	else {
		year_end = year
		month_end = month-v+1
	}

	let begin_time, end_time
	begin_time = year_begin.toString() +'-' +month_begin.toString() +'-01'
	end_time = year_end.toString() +'-' +month_end.toString() +'-01'
	return {
		'begin_time': begin_time,
		'end_time': end_time,
	}
}

	new Vue({
		el: '#book_download',
		data: {
			statistics_header: {
				'book': '書名',
				'all': '全部期間',
				'now': '本月',
			},
			statistics_datas: [],
			temp: {},
		},
		created: function () {
		},
		mounted: function () {
			this.statistics()
		},
		methods: {
			statistics: function () {
				let self = this;

				let today = new Date()
				let year, month, date

				year = today.getFullYear()
				month = today.getMonth()+1
				date = today.getDate()

				let querys = []
				let keys = []

				let all_query = rest_aj_send_memory('get', '/api/statistics/book_download/', {}, {'key': 'all'})
				querys.push(all_query)

				all_query
				.done(function(data) {
					key = data['memory']['key']
					self['temp'][key] = []
					_.each(data['data'].result, function(item){
						temp_obj = {}
						temp_obj['book'] = item.book
						temp_obj[key] = item.count
						self['temp'][key].push(temp_obj)
					})
				})
				.fail(function(xhr, result, statusText){
					console.log(xhr)
				})

				let begin_time, end_time
				begin_time = year.toString() +'-' +month.toString() +'-01'
				end_time = year.toString() +'-' +month.toString() +'-' +date.toString()

				let now_query = rest_aj_send_memory('get', '/api/statistics/book_download/', {'begin_time': begin_time, 'end_time': end_time,}, {'key': 'now'})
				querys.push(now_query)
				keys.push('now')

				now_query
				.done(function(data) {
					key = data['memory']['key']
					self['temp'][key] = []
					_.each(data['data'].result, function(item){
						temp_obj = {}
						temp_obj['book'] = item.book
						temp_obj[key] = item.count
						self['temp'][key].push(temp_obj)
					})
				})
				.fail(function(xhr, result, statusText){
					console.log(xhr)
				})

				_.each([1, 2, 3, 4, 5, 6,], function(v){

					time = genMonth(v)
					begin_time = time['begin_time']
					end_time = time['end_time']

					key = 'month' +v
					let month_query = rest_aj_send_memory('get', '/api/statistics/book_download/', {'begin_time': begin_time, 'end_time': end_time,}, {'key': key})
					querys.push(month_query)
					keys.push(key)
						self.statistics_header[key] = key

					month_query
					.done(function(data) {
						key = data['memory']['key']
						self['temp'][key] = []
						_.each(data['data'].result, function(item){
							temp_obj = {}
							temp_obj['book'] = item.book
							temp_obj[key] = item.count
							self['temp'][key].push(temp_obj)
						})
					})
					.fail(function(xhr, result, statusText){
						console.log(xhr)
					})

				})

				Promise.all(querys)
				.then(function () {
					self.statistics_datas = $.extendObjectArray(self.temp['all'], self.temp['now'], 'book')
					_.each(keys, function(v){
						self.statistics_datas = $.extendObjectArray(self.statistics_datas, self.temp[v], 'book')
					})
					fill_cell(self.statistics_datas, Object.keys(self.statistics_header), '0')
					self.statistics_datas.sort(compare('month5', 'desc'))
				})
				.catch(function (msg) {
					console.log(msg)
				})
			},
		},
	})

</script>
{% endblock %}