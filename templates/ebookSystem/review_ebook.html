{% extends "ebookSystem/review.html" %}
{% block title %}
{{ part }}審核
{% endblock %}

{% block content %}
{% csrf_token %}
{% include 'comp/list_vue_component.html' %}
{% include 'comp/table_vue_component.html' %}

<h3>審核</h3>

<div id="review_ebook">
	<h4>
	<span class="glyphicon glyphicon-check" aria-hidden="true" style="margin-top:20px;"></span> Step1: 基本資料</h4>
	<hr style="margin-top:5px;">

	<ul-component :data="info"></ul-component>

	<!-- step 2 -->
	<h4>
	<span class="glyphicon glyphicon-check" aria-hidden="true" style="margin-top:20px;"></span> Step2: 校對差異分析</h4>
	<hr style="margin-top:5px;">
	<table class="table table-striped table-hover">
		<tr>
			<th>編輯距離</th>
			<th>相同區數</th>
			<th>相同字數</th>
			<th>刪除字數</th>
			<th>新增字數</th>
			<th>原始字數</th>
			<th>校後字數</th>
			<th>增長字數</th>
		</tr>
		<tr>
			<td>{|{ analysis.edit_distance }|}</td>
			<td>{|{ analysis.len_block }|}</td>
			<td>{|{ analysis.same_character }|}</td>
			<td>{|{ analysis.delete_count }|}</td>
			<td>{|{ analysis.insert_count }|}</td>
			<td>{|{ analysis.src_count }|}</td>
			<td>{|{ analysis.dst_count }|}</td>
			<td>{|{ analysis.diff_count }|}</td>
		</tr>
	</table>

	<!--step 3-->
	<h4>
		<span class="glyphicon glyphicon-check" aria-hidden="true" style="margin-top:20px;"></span> Step3: 審核結果
	</h4>
	<hr style="margin-top:5px;">

	<template v-if="ebook.status==3">
		<div class="form-group">
			<input type="radio" id="success" value="success" v-model="result">
			<label for="success">成功</label>
			<br>
			<input type="radio" id="error" value="error" v-model="result">
			<label for="error">退回</label>
			<br>
			<template v-if="result=='error'">
				<label for="reason">原因</label>
				<input type="text" id="reason" v-model="reason">
			</template>
		</div>
		<button  class="btn btn-primary" @click="review()" type="submit" id="send_id" name="send">送出</button>
	</template>

</div>

<script>
	Vue.options.delimiters = ['{|{', '}|}'];

	new Vue({
		el: '#review_ebook',
		data: {
			pk: '',
			ebook: {},
			current_editrecord: {},
			analysis: {},
			reason: '',
			result: 'success', //success or error
		},
		computed: {
			info: function () {
				return {
					'服務時間': this.ebook.get_date,
					'線上時數': this.ebook.service_hours,
				}
			},
			url_ebook: function () {
				return '/ebookSystem/api/ebooks/' +this.pk +'/'
			},
			url_editrecord: function () {
				return '/ebookSystem/api/editrecords/' +this.ebook.current_editrecord.id +'/'
			},
		},
		created: function () {
			let self = this;

			this.pk = window.location.pathname.split('/')
			this.pk = this.pk[this.pk.length-2]

			rest_aj_send('get', this.url_ebook, {})
			.done(function(data) {

				self.ebook = data['data']

				if(iser(self.ebook.current_editrecord)){
					return -1
				}

				self.current_editrecord = self.ebook.current_editrecord

				rest_aj_send('get', self.url_editrecord +'action/analysis/', {})
				.done(function(data) {
					self.analysis = data['data']
				})
			})

		},
		methods: {
			review: function () {

				transferData = {
					'number_of_times':  this.info.number_of_times,
					'result': this.result,
					'reason': this.reason,
				}

				rest_aj_send('post', this.url_ebook +'action/review/', transferData)
				.done(function(data) {
					alertmessage('success', '審核已完成' +data['message'])
				})
				.fail(function(data){
					alertmessage('error', '' +data['message'])
				})

			},
		}

	})
</script>
{% endblock %}